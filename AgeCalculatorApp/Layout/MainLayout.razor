@using System.ComponentModel.DataAnnotations
@using AgeCalculatorApp.Validators
@inherits LayoutComponentBase
<div class="page">
    @* <div class="sidebar">
    <NavMenu />
    </div> *@

    <main>
        @*  <div class="top-row px-4">
        <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
        </div> *@
        <EditForm EditContext="editContext" OnValidSubmit="Calculate" OnInvalidSubmit="HandleInvalidSubmit" FormName="age-calculator-form">
            <fieldset>
                <DataAnnotationsValidator />
                <label class="@InvalidDayClass">DAY</label>
                <label class="@InvalidMonthClass">MONTH</label>
                <label class="@InvalidYearClass">YEAR</label>
                <div>
                    <InputNumber class="date-input" @bind-Value="Model!.Day" placeholder="DD" />
                    <ValidationMessage For="() => Model.Day" />
                </div>
                <div>
                    <InputNumber class="date-input" @bind-Value="Model!.Month" placeholder="MM" />
                    <ValidationMessage For="() => Model.Month" />
                </div>
                <div>
                    <InputNumber class="date-input" @bind-Value="Model!.Year" placeholder="YYYY" />
                    <ValidationMessage For="() => Model.Year" />
                </div>
            </fieldset>
            <hr />
            <button type="submit">
                <img src="images/icon-arrow.svg" />
            </button>
        </EditForm>
        <p class="calculated-age">
            <span><em>@Result.Years</em>years</span>
            <span><em>@Result.Months</em>months</span>
            <span><em>@Result.Days</em>days</span>
            @* <article class="content px-4">
            @Body
            </article> *@
        </p>
    </main>
</div>

@code {
    private EditContext? editContext;
    private ValidationMessageStore messageStore;

    [SupplyParameterFromForm]
    private Input? Model { get; set; }
    private CalculatedValues Result = new();
    private string? InvalidDayClass { get; set; } = null;
    private string? InvalidMonthClass { get; set; } = null;
    private string? InvalidYearClass { get; set; } = null;

    protected override void OnInitialized()
    {
        Model ??= new();
        editContext = new(Model);
        messageStore = new(editContext);
        editContext.OnValidationStateChanged += HandleValidationStateChanged;
    }

    private void Calculate()
    {
        Console.WriteLine($"Calculating... Day: {Model?.Day}, Month: {Model?.Month}, Year: {Model?.Year}");
        InvalidDayClass = InvalidMonthClass = InvalidYearClass = null;
    }

    private void HandleInvalidSubmit()
    {
        TriggerYearValidation();
        TriggerDateValidation();
    }

    private void HandleValidationStateChanged(object? sender, ValidationStateChangedEventArgs args)
    {
        var dayField = editContext!.Field(nameof(Model.Day));
        var monthField = editContext!.Field(nameof(Model.Month));
        var yearField = editContext!.Field(nameof(Model.Year));

        InvalidDayClass = editContext!.IsValid(dayField) ? null : "invalid";
        InvalidMonthClass = editContext!.IsValid(monthField) ? null : "invalid";
        InvalidYearClass = editContext!.IsValid(yearField) ? null : "invalid";

        var validationMessages = editContext.GetValidationMessages(dayField);

        if (validationMessages.Any(f => f.Contains("date")))
        {
            messageStore.Add(monthField, "");
            messageStore.Add(yearField, "");
        } else
        {
            messageStore.Clear(monthField);
            messageStore.Clear(yearField);
        }

        InvalidDayClass = editContext!.IsValid(dayField) ? null : "invalid";
        InvalidMonthClass = editContext!.IsValid(monthField) ? null : "invalid";
        InvalidYearClass = editContext!.IsValid(yearField) ? null : "invalid";
    }

    private void TriggerYearValidation()
    {
        var yearField = editContext!.Field(nameof(Model.Year));
        // Notify Blazor that the Year field has changed, which triggers validation
        editContext.NotifyFieldChanged(yearField);
    }

    private void TriggerDateValidation()
    {
        var dayField = editContext!.Field(nameof(Model.Day));
        // Notify Blazor that the Year field has changed, which triggers validation
        editContext.NotifyFieldChanged(dayField);
    }

    public class Input
    {
        private int _currentYear = DateTime.Today.Year;

        [ValidDate]
        public int? Day { get; set; }
        [Required(ErrorMessage = "This field is required")]
        [Range(1, 12, ErrorMessage = "Must be a valid month")]
        public int? Month { get; set; }
        [Required(ErrorMessage = "This field is required")]
        [YearRange]
        public int? Year { get; set; }
    }

    public class CalculatedValues
    {
        private const string Placeholder = "- -";

        public string Days { get; set; } = Placeholder;
        public string Months { get; set; } = Placeholder;
        public string Years { get; set; } = Placeholder;
    }

    public void Dispose()
    {
        if (editContext is not null)
        {
            editContext.OnValidationStateChanged -= HandleValidationStateChanged;
        }
    }
}
